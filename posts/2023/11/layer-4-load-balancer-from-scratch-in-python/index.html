<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Dhruv Sharma ">
<meta name="description" content="Have you ever wondered how web applications handle increasing traffic? As a software engineer, you might have heard of load balancers, which play a crucial role in managing the distribution of requests to multiple servers. This weekend, I decided to dive deep into socket programming and create a simple yet functional Layer 4 load balancer from scratch in Python. In this blog post, I&amp;rsquo;ll walk you through the process.
What is a Load Balancer anyway ?" />
<meta name="keywords" content="blog, python, networking" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://dhruvsha256.github.io/posts/2023/11/layer-4-load-balancer-from-scratch-in-python/" />


    <title>
        
            Layer 4 Load balancer from scratch in Python :: dhruv.Sha256  — Dhruv Sha256
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://dhruvsha256.github.io/main.4d467576ff1271e7fba333671de4e2256cdb6827159b0ba09f683c67644bf64a.css">



    <link rel="apple-touch-icon" sizes="180x180" href="https://dhruvsha256.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://dhruvsha256.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://dhruvsha256.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://dhruvsha256.github.io/site.webmanifest">
    <link rel="mask-icon" href="https://dhruvsha256.github.io/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://dhruvsha256.github.io/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Layer 4 Load balancer from scratch in Python">
<meta itemprop="description" content="Have you ever wondered how web applications handle increasing traffic? As a software engineer, you might have heard of load balancers, which play a crucial role in managing the distribution of requests to multiple servers. This weekend, I decided to dive deep into socket programming and create a simple yet functional Layer 4 load balancer from scratch in Python. In this blog post, I&rsquo;ll walk you through the process.
What is a Load Balancer anyway ?"><meta itemprop="datePublished" content="2023-11-01T14:51:45+05:30" />
<meta itemprop="dateModified" content="2023-11-01T14:51:45+05:30" />
<meta itemprop="wordCount" content="597"><meta itemprop="image" content="https://dhruvsha256.github.io/"/>
<meta itemprop="keywords" content="python,networking," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dhruvsha256.github.io/"/>

<meta name="twitter:title" content="Layer 4 Load balancer from scratch in Python"/>
<meta name="twitter:description" content="Have you ever wondered how web applications handle increasing traffic? As a software engineer, you might have heard of load balancers, which play a crucial role in managing the distribution of requests to multiple servers. This weekend, I decided to dive deep into socket programming and create a simple yet functional Layer 4 load balancer from scratch in Python. In this blog post, I&rsquo;ll walk you through the process.
What is a Load Balancer anyway ?"/>







    <meta property="article:published_time" content="2023-11-01 14:51:45 &#43;0530 IST" />










    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-25FRCXX5P4"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-25FRCXX5P4', { 'anonymize_ip': false });
}
</script>






    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://dhruvsha256.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text">$ cd /home/dhruv</span>
            <span class="logo__cursor" style=
                  "visibility:hidden;
                   background-color:#A595BA;
                   animation-duration:2s;">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner">
        
        
        
        
        
        
        
        
        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://dhruvsha256.github.io/about">about</a></li>
                <li><a href="https://dhruvsha256.github.io/posts">posts</a></li>
                <li><a href="https://dhruvsha256.github.io/resume" target="_blank">resume</a></li>
                <li><a href="https://dhruvsha256.github.io/projects">projects</a></li>
                

            </ul>
        </nav>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        3 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://dhruvsha256.github.io/posts/2023/11/layer-4-load-balancer-from-scratch-in-python/">Layer 4 Load balancer from scratch in Python</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>Have you ever wondered how web applications handle increasing traffic? As a software engineer, you might have heard of load balancers,
which play a crucial role in managing the distribution of requests to multiple servers.
This weekend, I decided to dive deep into socket programming and create a simple yet functional Layer 4 load balancer from scratch in Python.
In this blog post, I&rsquo;ll walk you through the process.</p>
<h3 id="what-is-a-load-balancer-anyway-">What is a Load Balancer anyway ?</h3>
<p>What is a load balancer anyway you may ask.
Imagine you&rsquo;ve built your own onlyfans clone, and it&rsquo;s gaining traction.
To handle the increased traffic, you can&rsquo;t infinitely scale your single server vertically.
Instead, you buy multiple servers and host your site across them.
However, a new problem arises: how do you effectively utilize the resources of all these servers? The answer is a load balancer.
It distributes incoming requests to different servers based on a selection criteria, like a simple round-robin algorithm.</p>
<h3 id="layer-4-vs-layer-7-load-balancers">Layer 4 vs. Layer 7 Load Balancers</h3>
<ul>
<li>A layer 7 load balancer works on you guessed it right, layer 7 of OSI model which is the
application layer, so for every incoming request, it do multiple things like eliminating
TLS, based on the data received redirect it to a specific server.
The whole flow goes like this: client -&gt; load balancer (decodes request) -&gt; server
Loadbalancer essentially creates a new request to server.
All the data in request body is accessible to it. So we can say it can do things a
little smartly.</li>
</ul>
<pre class="mermaid">sequenceDiagram
    participant Client
    participant LoadBalancer
    participant Server
    Client->>LoadBalancer: Request R1
    LoadBalancer->>Server: Request R2
    Server->>LoadBalancer: Response R1
    LoadBalancer->>Client: Response R2
</pre>

<ul>
<li>A layer 4 load balancer on the other hand works on (you guess), which is Transport Layer of OSI model.
It instead of decoding the request, directly sends the packet to server.
It basically act as a relay between client and server, which is faster but &hellip; dumb.</li>
</ul>
<h3 id="the-code">The code</h3>
<p>Let&rsquo;s dive into the code to build our Layer 4 load balancer.
The first step is to listen to an address and receive data from clients.
We will be using Python&rsquo;s socket library for this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        sock<span style="color:#f92672">.</span>bind((HOST, PORT))
</span></span><span style="display:flex;"><span>        sock<span style="color:#f92672">.</span>listen()
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Listening on port: </span><span style="color:#e6db74">{</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            client_conn, client_addr <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>accept()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> client_conn:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connected by </span><span style="color:#e6db74">{</span>client_addr<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> client_conn<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>                print(data<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>        sock<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>Now that we are receiving connections from clients,
we need to somehow relay requests and responses between them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward_request</span>(source, destination):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Sending data from </span><span style="color:#e6db74">{</span>source<span style="color:#f92672">.</span>getsockname()<span style="color:#e6db74">}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{</span>destination<span style="color:#f92672">.</span>getsockname()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(data) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                destination<span style="color:#f92672">.</span>send(data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>            source<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>            destination<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>We will be needing two separate threads for this (one for receiving client request and
sending it to server, and one receiving server response and sending it to client)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    c2b_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>forward_request, args<span style="color:#f92672">=</span>(client_conn, backend_conn))
</span></span><span style="display:flex;"><span>    b2c_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>forward_request, args<span style="color:#f92672">=</span>(backend_conn, client_conn))
</span></span><span style="display:flex;"><span>    c2b_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    b2c_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    c2b_thread<span style="color:#f92672">.</span>join()
</span></span><span style="display:flex;"><span>    b2c_thread<span style="color:#f92672">.</span>join()
</span></span></code></pre></div><p>Now comes the tricky part: what if one server dies? It would be foolish to relay requests to a dead server.
We need a heartbeat mechanism to periodically check if the server is up and running.
If it isn&rsquo;t, we should exclude it from our pool of servers.
We must perform this operation without blocking our primary server, so we&rsquo;ll create a separate thread for it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_server_heart_beat</span>(server):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>server<span style="color:#f92672">.</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>server<span style="color:#f92672">.</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">/health&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> resp<span style="color:#f92672">.</span>text <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;up&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_heartbeat</span>(server, delay):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            server_heart_beat <span style="color:#f92672">=</span> get_server_heart_beat(server)
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>update_health_status(server_heart_beat)
</span></span><span style="display:flex;"><span>            sleep(delay)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_health</span>(servers):
</span></span><span style="display:flex;"><span>        threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> servers:
</span></span><span style="display:flex;"><span>            t <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>update_heartbeat, args<span style="color:#f92672">=</span>(s, <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>            threads<span style="color:#f92672">.</span>append(t)
</span></span><span style="display:flex;"><span>            t<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> threads
</span></span></code></pre></div><p>We are almost done just need to test our load balancer.</p>
<script data-theme="asciinema" src="https://asciinema.org/a/618289.js" id="asciicast-618289" async></script>
<p>Full code can be found on my <a href="https://github.com/dhruvSHA256/load-balancer">github</a></p>

      </div>

        
          <script type="module">
            import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
            var config = {
              startOnLoad: true,
              theme:'dark',
              align:'center',
            };
            mermaid.initialize(config);
          </script>
        
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://dhruvsha256.github.io/tags/python/">python</a></span>
        <span class="tag"><a href="https://dhruvsha256.github.io/tags/networking/">networking</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        597 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2023-11-01 14:51
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://dhruvsha256.github.io/posts/2022/07/hello-world/">
                    <span class="button__icon">←</span>
                    <span class="button__text">hello world</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://dhruvsha256.github.io/posts/2023/05/solid-principles-in-python/">
                    <span class="button__text">Solid Principles in Python</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

<script src="https://giscus.app/client.js"
        data-repo="dhruvsha256/dhruvsha256.github.io"
        data-repo-id="R_kgDOIYOkrQ"
        data-category="General"
        data-category-id="DIC_kwDOIYOkrc4CacVm"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="noborder_dark"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the comments powered by giscus.</noscript>

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            
            
            
            <span><a href="https://dhruvsha256.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
            
        </div>
    </div>
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://dhruvsha256.github.io/bundle.min.bb2c6bc3ed452ca4759660e4020811f248bc2320081559e8a32d8b0092773852941133639d35e8370d03d3ddaa750b1edd6b343c5bd22a55d5bdeae8f648f49b.js" integrity="sha512-uyxrw&#43;1FLKR1lmDkAggR8ki8IyAIFVnooy2LAJJ3OFKUETNjnTXoNw0D092qdQse3Ws0PFvSKlXVvero9kj0mw=="></script>



    </body>
</html>
